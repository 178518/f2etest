{"id":1486626,"slug":"browser-cloud","title":"浏览器云架构","book_id":245753,"book":{"id":245753,"type":"Book","slug":"f2etest","name":"F2etest","user_id":296279,"description":"F2etest 是一个面向前端、测试、产品等岗位的多浏览器兼容性测试整体解决方案。","creator_id":94302,"public":1,"items_count":12,"likes_count":0,"watches_count":2,"content_updated_at":"2019-04-23T05:44:30.303Z","updated_at":"2019-04-23T06:32:14.000Z","created_at":"2019-03-21T03:15:48.000Z","namespace":"linshuoting/f2etest","user":{"id":94302,"type":"User","login":"linshuoting","name":"说听(Stngle)","description":"F&D艺术家   \nhttps://github.com/Stngle","avatar_url":"https://cdn.nlark.com/yuque/0/2019/png/94302/1553150368242-avatar/4fa5a6cc-1636-43cd-b085-fce8ad30be09.png","large_avatar_url":"https://cdn.nlark.com/yuque/0/2019/png/94302/1553150368242-avatar/4fa5a6cc-1636-43cd-b085-fce8ad30be09.png?x-oss-process=image/resize,m_fill,w_320,h_320","medium_avatar_url":"https://cdn.nlark.com/yuque/0/2019/png/94302/1553150368242-avatar/4fa5a6cc-1636-43cd-b085-fce8ad30be09.png?x-oss-process=image/resize,m_fill,w_160,h_160","small_avatar_url":"https://cdn.nlark.com/yuque/0/2019/png/94302/1553150368242-avatar/4fa5a6cc-1636-43cd-b085-fce8ad30be09.png?x-oss-process=image/resize,m_fill,w_80,h_80","books_count":1,"public_books_count":0,"followers_count":3,"following_count":2,"created_at":"2018-03-21T12:59:06.000Z","updated_at":"2019-04-23T05:43:09.000Z","_serializer":"v2.user"},"_serializer":"v2.book"},"user_id":182712,"creator":{"id":182712,"type":"User","login":"undead25","name":"双龙","description":null,"avatar_url":"https://cdn.nlark.com/yuque/0/2019/png/182712/1554346835965-avatar/a9f57da4-3a12-43bc-be2c-85b7e215b7c7.png","large_avatar_url":"https://cdn.nlark.com/yuque/0/2019/png/182712/1554346835965-avatar/a9f57da4-3a12-43bc-be2c-85b7e215b7c7.png?x-oss-process=image/resize,m_fill,w_320,h_320","medium_avatar_url":"https://cdn.nlark.com/yuque/0/2019/png/182712/1554346835965-avatar/a9f57da4-3a12-43bc-be2c-85b7e215b7c7.png?x-oss-process=image/resize,m_fill,w_160,h_160","small_avatar_url":"https://cdn.nlark.com/yuque/0/2019/png/182712/1554346835965-avatar/a9f57da4-3a12-43bc-be2c-85b7e215b7c7.png?x-oss-process=image/resize,m_fill,w_80,h_80","books_count":0,"public_books_count":0,"followers_count":0,"following_count":1,"created_at":"2018-09-26T16:45:26.000Z","updated_at":"2019-04-04T03:00:41.000Z","_serializer":"v2.user"},"format":"lake","body":"","body_draft":"","body_html":"<h2 id=\"cffab21d\">一、浏览器云的工作原理</h2><p><img alt=\"原理大图.jpg\" title=\"原理大图.jpg\" src=\"https://cdn.nlark.com/yuque/0/2019/jpeg/182712/1554716628801-d0a3bc18-3707-41d5-b7b2-a8552ef4a03e.jpeg#align=left&amp;display=inline&amp;height=699&amp;name=%E5%8E%9F%E7%90%86%E5%A4%A7%E5%9B%BE.jpg&amp;originHeight=1150&amp;originWidth=806&amp;size=98615&amp;status=done&amp;width=490\" style=\"max-width: 600px; width: 490px;\" /></p><p><br /></p><p>浏览器云为用户的请求访问提供了一个真实的运行环境，如何把远端 Windows Server 上访问的情况提供给客户，成为了浏览器云需要解决的问题，原理解析以单机的 <span>Windows Server 为例。</span></p><p><br /></p><p>客户从浏览器启动应用，看到 Windows Server 的远程桌面，到和远程桌面的交互。过程涉及到浏览器云提供的三个比较关键的功能点。<strong>远程桌面</strong>，<strong>用户管理</strong>和<strong>启动应用。</strong></p><p><br /></p><h3 id=\"86916edb\">1.1 远程桌面</h3><p><br /></p><p>用户在访问 F2etest 门户，点击浏览器的 icon，进入如下界面。</p><p><br /></p><p><img alt=\"f2e-browser.jpg\" title=\"f2e-browser.jpg\" src=\"https://cdn.nlark.com/yuque/0/2019/jpeg/182712/1554716628811-d4ec2863-e503-445b-a49e-3b30455840b7.jpeg#align=left&amp;display=inline&amp;height=393&amp;name=f2e-browser.jpg&amp;originHeight=1516&amp;originWidth=2878&amp;size=243089&amp;status=done&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><p><br /></p><p>用户<span>实际上</span>是建立了一个远程桌面的访问，通过浏览器直接访问到了 Windows Server 机器上了。远程桌面会话的建立是通过 Linux 机器上的 Guacamole Server 与 Windows Server 自身的远程桌面服务完成的。<span>Guacamole 是</span>一个提供远程桌面的解决方案的开源项目，用户通过浏览器就能操作虚拟机。</p><p><br /></p><p><span>Guacamole 提供了多种与远程机器的连接协议，</span><span>F2etest 使用的是只需要配置IP和端口号就可以连接的 RDP 协议。登录如下图所示，输入账号和密码即可连接。</span></p><p><img alt=\"Windows-Login.png\" title=\"Windows-Login.png\" src=\"https://cdn.nlark.com/yuque/0/2019/png/182712/1554716628810-2d0483f8-4f9e-4eea-a1d8-3d43ca253650.png#align=left&amp;display=inline&amp;height=337&amp;name=Windows-Login.png&amp;originHeight=337&amp;originWidth=747&amp;size=29883&amp;status=done&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><p><br /></p><p><br /></p><h3 id=\"3851ccf1\">1.2 用户管理</h3><p><br /></p><p>为了做到多个用户可以同时访问 F2etest 而不相互干扰，每个用户远程访问浏览器云是作为一个独立的用户。<span>浏览器云使用的 </span>Windows Server 服务器和 Linux 相似，是支持多用户独立访问的。多用户的管理是通过 <span>Windows Server 系统本身来实现的，新用户的添加是由 F2etest 实现的。</span></p><p><br /></p><h5 id=\"49a51f68\">添加用户</h5><p><br /></p><p>配置 IIS 服务器，将 vb 脚本 setuser.asp 添加到 IIS 服务，对外提供服务。</p><p><br /></p><pre><code>setuser.asp\n\nfunction setUserPassword(username, password)\n    On Error Resume Next\n    dim oSystem,oUser,oGroup\n    \n    Set oSystem=GetObject(&quot;WinNT://127.0.0.1&quot;)\n    \n    Set oUser=oSystem.GetObject(&quot;user&quot;,username)\n\n    if err &lt;&gt; 0 then\n        err = 0\n        ' 增加新用户\n        Set oUser=oSystem.Create(&quot;user&quot;,username)\n        oUser.SetPassword password\n        oUser.Put &quot;userFlags&quot;, &amp;h10040 '密码永不过期\n        oUser.Setinfo\n        \n        Set oGroup=oSystem.GetObject(&quot;Group&quot;,&quot;Users&quot;)\n        oGroup.Add (&quot;winnt://&quot;&amp;username)\n    else\n        ' 修改密码\n        oUser.SetPassword password\n        oUser.Setinfo\n    end if\nend function </code></pre><p><br /></p><p>访问添加用户链接效果如下。</p><p><img alt=\"setuser.jpg\" title=\"setuser.jpg\" src=\"https://cdn.nlark.com/yuque/0/2019/jpeg/182712/1554716628819-d1b3884b-4943-4c79-96b2-a0857df47832.jpeg#align=left&amp;display=inline&amp;height=514&amp;name=setuser.jpg&amp;originHeight=1268&amp;originWidth=1840&amp;size=131328&amp;status=done&amp;width=746\" style=\"max-width: 600px; width: 746px;\" /></p><h4 id=\"d41d8cd9\"><br /></h4><h3 id=\"7db0e8c6\">1.3 启动应用</h3><p><br /></p><p>用户在浏览器点击应用图标的时候，是怎么启动浏览器云上的应用的呢？F2etest 使用到了 RemoteApp 功能。RemoteApp 和桌面连接是一项用于访问工作区网络管理员提供的程序和桌面（远程计算机和虚拟计算机）的功能。当您在家时，您可以访问通常在工作时需要使用的所有程序和计算机。通过连接，所有这些资源都位于计算机上一个容易访问的文件夹中。几乎可以像在本地网络或自己的计算机上一样使用这些资源。</p><p><br /></p><p>以启动 Chrome 浏览器的脚本为例，首先会把 <strong>f2etest-browsers/app/特殊应用/chrome.bat </strong>文件添加到Windows Server 的 RemoteApp 服务中。</p><p><br /></p><p>chrome.bat 关键代码如下。</p><p><br /></p><pre><code>@echo off\n\nrem 请这里配置f2etest的域名\nset f2etestDomain=f2etest.xxx.com\nset appid=chrome\n\nrem 命令行参数\nset proxymode=&quot;%1&quot;\nset proxyurl=%2\nset url=%3\nset apiKey=%4\n\nrem 设置代理\nset proxypath=&quot;HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings&quot;\nreg add %proxypath% /v &quot;ProxyEnable&quot; /t REG_DWORD /d 0 /f&gt;nul \nset proxydef=\nif %proxyurl% equ &quot;&quot; set proxydef=1\nif %proxyurl% equ default set proxydef=1\nif %proxyurl% equ &quot;default&quot; set proxydef=1\nif defined proxydef set proxyurl=&quot;http://%f2etestDomain%/getHosts.pac?name=%USERNAME%&quot;\nif %proxymode% equ &quot;noproxy&quot; (\n\tset proxyurl=&quot;&quot;\n)\nif %proxyurl% neq &quot;&quot; (\n\trem 开启代理\n\treg add %proxypath% /v &quot;AutoConfigURL&quot; /d %proxyurl% /f &gt;nul\n) else (\n\trem 关闭代理\n\treg delete %proxypath% /v &quot;AutoConfigURL&quot; /f &gt; nul\n)\n\nrem 打开应用\ntaskkill /fi &quot;username eq %username%&quot; /s %computername% /u %username% /f -IM chrome.exe &gt;nul\nstart /MAX &quot;&quot; &quot;C:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exe&quot; --allow-no-sandbox-job %url% %proxyParam%\n\nrem 打点统计\nstart &quot;&quot; curl &quot;http://%f2etestDomain%/applog?userid=%USERNAME%&amp;appid=%appid%&amp;isweb=%isWeb%&quot;\n</code></pre><p><br /></p><p>通过接收请求 URL 链接里的参数来设置代理模式，代理 IP 等，最后启动本地的 Chrome 应用。</p>","body_lake":"<!doctype lake><h2 id=\"cffab21d\"><anchor />一<focus />、浏览器云的工作原理</h2><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fjpeg%2F182712%2F1554716628801-d0a3bc18-3707-41d5-b7b2-a8552ef4a03e.jpeg%22%2C%22originWidth%22%3A806%2C%22originHeight%22%3A1150%2C%22name%22%3A%22%E5%8E%9F%E7%90%86%E5%A4%A7%E5%9B%BE.jpg%22%2C%22size%22%3A98615%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A490%2C%22height%22%3A699%7D\"></card></p><p><br /></p><p>浏览器云为用户的请求访问提供了一个真实的运行环境，如何把远端 Windows Server 上访问的情况提供给客户，成为了浏览器云需要解决的问题，原理解析以单机的 <span>Windows Server 为例。</span></p><p><br /></p><p>客户从浏览器启动应用，看到 Windows Server 的远程桌面，到和远程桌面的交互。过程涉及到浏览器云提供的三个比较关键的功能点。<strong>远程桌面</strong>，<strong>用户管理</strong>和<strong>启动应用。</strong></p><p><br /></p><h3 id=\"86916edb\">1.1 远程桌面</h3><p><br /></p><p>用户在访问 F2etest 门户，点击浏览器的 icon，进入如下界面。</p><p><br /></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fjpeg%2F182712%2F1554716628811-d4ec2863-e503-445b-a49e-3b30455840b7.jpeg%22%2C%22originWidth%22%3A2878%2C%22originHeight%22%3A1516%2C%22name%22%3A%22f2e-browser.jpg%22%2C%22size%22%3A243089%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A746%2C%22height%22%3A393%7D\"></card></p><p><br /></p><p>用户<span>实际上</span>是建立了一个远程桌面的访问，通过浏览器直接访问到了 Windows Server 机器上了。远程桌面会话的建立是通过 Linux 机器上的 Guacamole Server 与 Windows Server 自身的远程桌面服务完成的。<span>Guacamole 是</span>一个提供远程桌面的解决方案的开源项目，用户通过浏览器就能操作虚拟机。</p><p><br /></p><p><span>Guacamole 提供了多种与远程机器的连接协议，</span><span>F2etest 使用的是只需要配置IP和端口号就可以连接的 RDP 协议。登录如下图所示，输入账号和密码即可连接。</span></p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fpng%2F182712%2F1554716628810-2d0483f8-4f9e-4eea-a1d8-3d43ca253650.png%22%2C%22originWidth%22%3A747%2C%22originHeight%22%3A337%2C%22name%22%3A%22Windows-Login.png%22%2C%22size%22%3A29883%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A746%2C%22height%22%3A337%7D\"></card></p><p><br /></p><p><br /></p><h3 id=\"3851ccf1\">1.2 用户管理</h3><p><br /></p><p>为了做到多个用户可以同时访问 F2etest 而不相互干扰，每个用户远程访问浏览器云是作为一个独立的用户。<span>浏览器云使用的 </span>Windows Server 服务器和 Linux 相似，是支持多用户独立访问的。多用户的管理是通过 <span>Windows Server 系统本身来实现的，新用户的添加是由 F2etest 实现的。</span></p><p><br /></p><h5 id=\"49a51f68\">添加用户</h5><p><br /></p><p>配置 IIS 服务器，将 vb 脚本 setuser.asp 添加到 IIS 服务，对外提供服务。</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22plain%22%2C%22code%22%3A%22setuser.asp%5Cn%5Cnfunction%20setUserPassword(username%2C%20password)%5Cn%20%20%20%20On%20Error%20Resume%20Next%5Cn%20%20%20%20dim%20oSystem%2CoUser%2CoGroup%5Cn%20%20%20%20%5Cn%20%20%20%20Set%20oSystem%3DGetObject(%5C%22WinNT%3A%2F%2F127.0.0.1%5C%22)%5Cn%20%20%20%20%5Cn%20%20%20%20Set%20oUser%3DoSystem.GetObject(%5C%22user%5C%22%2Cusername)%5Cn%5Cn%20%20%20%20if%20err%20%3C%3E%200%20then%5Cn%20%20%20%20%20%20%20%20err%20%3D%200%5Cn%20%20%20%20%20%20%20%20'%20%E5%A2%9E%E5%8A%A0%E6%96%B0%E7%94%A8%E6%88%B7%5Cn%20%20%20%20%20%20%20%20Set%20oUser%3DoSystem.Create(%5C%22user%5C%22%2Cusername)%5Cn%20%20%20%20%20%20%20%20oUser.SetPassword%20password%5Cn%20%20%20%20%20%20%20%20oUser.Put%20%5C%22userFlags%5C%22%2C%20%26h10040%20'%E5%AF%86%E7%A0%81%E6%B0%B8%E4%B8%8D%E8%BF%87%E6%9C%9F%5Cn%20%20%20%20%20%20%20%20oUser.Setinfo%5Cn%20%20%20%20%20%20%20%20%5Cn%20%20%20%20%20%20%20%20Set%20oGroup%3DoSystem.GetObject(%5C%22Group%5C%22%2C%5C%22Users%5C%22)%5Cn%20%20%20%20%20%20%20%20oGroup.Add%20(%5C%22winnt%3A%2F%2F%5C%22%26username)%5Cn%20%20%20%20else%5Cn%20%20%20%20%20%20%20%20'%20%E4%BF%AE%E6%94%B9%E5%AF%86%E7%A0%81%5Cn%20%20%20%20%20%20%20%20oUser.SetPassword%20password%5Cn%20%20%20%20%20%20%20%20oUser.Setinfo%5Cn%20%20%20%20end%20if%5Cnend%20function%20%22%2C%22id%22%3A%22iOjXq%22%7D\"></card><p><br /></p><p>访问添加用户链接效果如下。</p><p><card type=\"inline\" name=\"image\" value=\"data:%7B%22src%22%3A%22https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2019%2Fjpeg%2F182712%2F1554716628819-d1b3884b-4943-4c79-96b2-a0857df47832.jpeg%22%2C%22originWidth%22%3A1840%2C%22originHeight%22%3A1268%2C%22name%22%3A%22setuser.jpg%22%2C%22size%22%3A131328%2C%22display%22%3A%22inline%22%2C%22align%22%3A%22left%22%2C%22linkTarget%22%3A%22_blank%22%2C%22status%22%3A%22done%22%2C%22width%22%3A746%2C%22height%22%3A514%7D\"></card></p><h4 id=\"d41d8cd9\"><br /></h4><h3 id=\"7db0e8c6\">1.3 启动应用</h3><p><br /></p><p>用户在浏览器点击应用图标的时候，是怎么启动浏览器云上的应用的呢？F2etest 使用到了 RemoteApp 功能。RemoteApp 和桌面连接是一项用于访问工作区网络管理员提供的程序和桌面（远程计算机和虚拟计算机）的功能。当您在家时，您可以访问通常在工作时需要使用的所有程序和计算机。通过连接，所有这些资源都位于计算机上一个容易访问的文件夹中。几乎可以像在本地网络或自己的计算机上一样使用这些资源。</p><p><br /></p><p>以启动 Chrome 浏览器的脚本为例，首先会把 <strong>f2etest-browsers/app/特殊应用/chrome.bat </strong>文件添加到Windows Server 的 RemoteApp 服务中。</p><p><br /></p><p>chrome.bat 关键代码如下。</p><p><br /></p><card type=\"block\" name=\"codeblock\" value=\"data:%7B%22mode%22%3A%22plain%22%2C%22code%22%3A%22%40echo%20off%5Cn%5Cnrem%20%E8%AF%B7%E8%BF%99%E9%87%8C%E9%85%8D%E7%BD%AEf2etest%E7%9A%84%E5%9F%9F%E5%90%8D%5Cnset%20f2etestDomain%3Df2etest.xxx.com%5Cnset%20appid%3Dchrome%5Cn%5Cnrem%20%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0%5Cnset%20proxymode%3D%5C%22%251%5C%22%5Cnset%20proxyurl%3D%252%5Cnset%20url%3D%253%5Cnset%20apiKey%3D%254%5Cn%5Cnrem%20%E8%AE%BE%E7%BD%AE%E4%BB%A3%E7%90%86%5Cnset%20proxypath%3D%5C%22HKCU%5C%5CSoftware%5C%5CMicrosoft%5C%5CWindows%5C%5CCurrentVersion%5C%5CInternet%20Settings%5C%22%5Cnreg%20add%20%25proxypath%25%20%2Fv%20%5C%22ProxyEnable%5C%22%20%2Ft%20REG_DWORD%20%2Fd%200%20%2Ff%3Enul%20%5Cnset%20proxydef%3D%5Cnif%20%25proxyurl%25%20equ%20%5C%22%5C%22%20set%20proxydef%3D1%5Cnif%20%25proxyurl%25%20equ%20default%20set%20proxydef%3D1%5Cnif%20%25proxyurl%25%20equ%20%5C%22default%5C%22%20set%20proxydef%3D1%5Cnif%20defined%20proxydef%20set%20proxyurl%3D%5C%22http%3A%2F%2F%25f2etestDomain%25%2FgetHosts.pac%3Fname%3D%25USERNAME%25%5C%22%5Cnif%20%25proxymode%25%20equ%20%5C%22noproxy%5C%22%20(%5Cn%5Ctset%20proxyurl%3D%5C%22%5C%22%5Cn)%5Cnif%20%25proxyurl%25%20neq%20%5C%22%5C%22%20(%5Cn%5Ctrem%20%E5%BC%80%E5%90%AF%E4%BB%A3%E7%90%86%5Cn%5Ctreg%20add%20%25proxypath%25%20%2Fv%20%5C%22AutoConfigURL%5C%22%20%2Fd%20%25proxyurl%25%20%2Ff%20%3Enul%5Cn)%20else%20(%5Cn%5Ctrem%20%E5%85%B3%E9%97%AD%E4%BB%A3%E7%90%86%5Cn%5Ctreg%20delete%20%25proxypath%25%20%2Fv%20%5C%22AutoConfigURL%5C%22%20%2Ff%20%3E%20nul%5Cn)%5Cn%5Cnrem%20%E6%89%93%E5%BC%80%E5%BA%94%E7%94%A8%5Cntaskkill%20%2Ffi%20%5C%22username%20eq%20%25username%25%5C%22%20%2Fs%20%25computername%25%20%2Fu%20%25username%25%20%2Ff%20-IM%20chrome.exe%20%3Enul%5Cnstart%20%2FMAX%20%5C%22%5C%22%20%5C%22C%3A%5C%5CProgram%20Files%20(x86)%5C%5CGoogle%5C%5CChrome%5C%5CApplication%5C%5Cchrome.exe%5C%22%20--allow-no-sandbox-job%20%25url%25%20%25proxyParam%25%5Cn%5Cnrem%20%E6%89%93%E7%82%B9%E7%BB%9F%E8%AE%A1%5Cnstart%20%5C%22%5C%22%20curl%20%5C%22http%3A%2F%2F%25f2etestDomain%25%2Fapplog%3Fuserid%3D%25USERNAME%25%26appid%3D%25appid%25%26isweb%3D%25isWeb%25%5C%22%5Cn%22%2C%22id%22%3A%226iWA7%22%7D\"></card><p><br /></p><p>通过接收请求 URL 链接里的参数来设置代理模式，代理 IP 等，最后启动本地的 Chrome 应用。</p>","public":1,"status":null,"likes_count":4,"comments_count":0,"content_updated_at":"2019-04-10T07:44:08.000Z","deleted_at":null,"created_at":"2019-04-08T09:43:45.000Z","updated_at":"2019-04-23T06:15:01.000Z","published_at":"2019-04-10T07:44:08.000Z","first_published_at":"2019-04-08T09:46:57.000Z","word_count":1042,"cover":null,"description":"一、浏览器云的工作原理浏览器云为用户的请求访问提供了一个真实的运行环境，如何把远端 Windows Server 上访问的情况提供给客户，成为了浏览器云需要解决的问题，原理解析以单机的 Windows Server 为例。客户从浏览器启动应用，看到 Windows Server 的远程桌面，到...","custom_description":null,"_serializer":"v2.doc_detail"}